Code Review & Performance Analysis - AyoBuatBaik
ğŸ” Executive Summary
Saya telah melakukan analisis menyeluruh terhadap project AyoBuatBaik. Secara keseluruhan, codenya sudah cukup baik, namun ada beberapa area yang perlu ditingkatkan untuk optimasi performa dan best practices.

Level Prioritas:
ğŸ”´ CRITICAL - Harus diperbaiki segera
ğŸŸ  HIGH - Sangat disarankan untuk diperbaiki
ğŸŸ¡ MEDIUM - Recommended untuk perbaikan
ğŸŸ¢ LOW - Nice to have
ğŸ”´ CRITICAL ISSUES
1. N+1 Query Problem ğŸ”´
Lokasi: Multiple Controllers

Problem yang Ditemukan:
a) 
HomeController.php:L16-18

$featuredPrograms = ProgramDonasi::where('featured', 1)
    ->where('status', 'active')
    ->orderBy('id', 'desc')
    ->take(3)
    ->get();
$otherPrograms = ProgramDonasi::where('featured', 0)
    ->orderBy('id', 'desc')
    ->get();
Masalah: Saat di Blade 
home.blade.php
 line 135 ada $program->kategori->slug, ini akan menghasilkan N+1 query karena tidak di-eager load.

b) 
DonasiController.php:L129

$phone = preg_replace('/^0/', '62', $donation->donor_phone);
$programName = $donation->program->title;  // N+1 Query!
$amount = number_format($donation->amount, 0, ',', '.');
Ini dipanggil di dalam transaction callback, tapi $donation tidak punya eager loading untuk 
program
.

c) 
HomeController.php:L47-51

$donations = Donation::where('program_donasi_id', $program->id)
    ->where('status', 'success')
    ->latest()
    ->limit(20)
    ->get();
Jika ada relasi tambahan yang diakses di view, ini bisa jadi N+1.

ğŸ’¡ Solusi:
1. Perbaiki 
HomeController.php
:

public function index()
{
    // Eager load kategori dan penggalang
    $featuredPrograms = ProgramDonasi::with(['kategori', 'penggalang'])
        ->where('featured', 1)
        ->where('status', 'active')
        ->orderBy('id', 'desc')
        ->take(3)
        ->get();
    $otherPrograms = ProgramDonasi::with(['kategori', 'penggalang'])
        ->where('featured', 0)
        ->where('status', 'active')  // Tambahkan filter status
        ->orderBy('id', 'desc')
        ->get();
    // ... rest of code
}
public function program($slug)
{
    // Eager load relations
    $program = ProgramDonasi::with(['kategori', 'penggalang'])
        ->where('slug', $slug)
        ->firstOrFail();
    
    // ... rest of code
}
2. Perbaiki 
DonasiController.php
:

public function notification(Request $request)
{
    Log::info('CALLBACK MIDTRANS MASUK:', $request->all());
    $notif = $request->all();
    DB::transaction(function () use ($notif) {
        $status = $notif['transaction_status'];
        $orderId = $notif['order_id'];
        $originalOrderId = explode('-R', $orderId)[0];
        // FIX: Eager load program
        $donation = Donation::with('program')  // âœ… Add this
            ->where('donation_code', $orderId)
            ->orWhere('donation_code', 'LIKE', $originalOrderId . '%')
            ->firstOrFail();
        // ... rest of code
    });
}
2. Missing Database Indexes ğŸ”´
Masalah: Tidak ada index pada kolom yang sering di-query, ini akan sangat lambat ketika data sudah banyak.

Index yang Harus Ditambahkan:
a) Table 
donations
:

status - sering digunakan untuk filter
program_donasi_id + status - composite index
donation_code - sudah unique, OK âœ…
donor_email - untuk search
donor_phone - untuk search
status_change_at - untuk sorting
b) Table program_donasi:

status - untuk filter
featured - untuk filter
slug - sudah unique, OK âœ…
kategori_id - foreign key index
end_date - untuk sorting
ğŸ’¡ Solusi:
Buat migration baru:

<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
return new class extends Migration
{
    public function up(): void
    {
        Schema::table('donations', function (Blueprint $table) {
            // Index untuk filtering status
            $table->index('status', 'idx_donations_status');
            
            // Composite index untuk query: WHERE program_donasi_id = X AND status = Y
            $table->index(['program_donasi_id', 'status'], 'idx_donations_program_status');
            
            // Index untuk search donor
            $table->index('donor_email', 'idx_donations_donor_email');
            $table->index('donor_phone', 'idx_donations_donor_phone');
            
            // Index untuk sorting
            $table->index('status_change_at', 'idx_donations_status_change_at');
        });
        Schema::table('program_donasi', function (Blueprint $table) {
            // Index untuk filtering
            $table->index('status', 'idx_program_status');
            $table->index('featured', 'idx_program_featured');
            
            // Composite untuk WHERE status = X AND featured = Y
            $table->index(['status', 'featured'], 'idx_program_status_featured');
            
            // Index untuk sorting
            $table->index('end_date', 'idx_program_end_date');
        });
    }
    public function down(): void
    {
        Schema::table('donations', function (Blueprint $table) {
            $table->dropIndex('idx_donations_status');
            $table->dropIndex('idx_donations_program_status');
            $table->dropIndex('idx_donations_donor_email');
            $table->dropIndex('idx_donations_donor_phone');
            $table->dropIndex('idx_donations_status_change_at');
        });
        Schema::table('program_donasi', function (Blueprint $table) {
            $table->dropIndex('idx_program_status');
            $table->dropIndex('idx_program_featured');
            $table->dropIndex('idx_program_status_featured');
            $table->dropIndex('idx_program_end_date');
        });
    }
};
Command untuk run:

php artisan make:migration add_indexes_for_performance
# Copy code di atas
php artisan migrate
ğŸŸ  HIGH PRIORITY ISSUES
3. Tidak Ada Caching ğŸŸ 
Masalah: Data yang jarang berubah seperti kategori, slider, program featured, dll tidak di-cache. Setiap request akan query ke database.

ğŸ’¡ Solusi:
a) Cache Kategori (
HomeController.php
):

use Illuminate\Support\Facades\Cache;
public function index()
{
    // Cache kategori selama 1 jam
    $kategori = Cache::remember('kategori_donasi', 3600, function () {
        return KategoriDonasi::orderBy('name')->get();
    });
    // Cache slider selama 30 menit
    $sliders = Cache::remember('sliders_home', 1800, function () {
        return Slider::orderBy('urutan', 'asc')->get();l
    });
    // Featured programs bisa di-cache 10 menit
    $featuredPrograms = Cache::remember('featured_programs', 600, function () {
        return ProgramDonasi::with(['kategori', 'penggalang'])
            ->where('featured', 1)
            ->where('status', 'active')
            ->orderBy('id', 'desc')
            ->take(3)
            ->get();
    });
    // Other programs - cache lebih pendek (5 menit) karena bisa sering update
    $otherPrograms = Cache::remember('other_programs', 300, function () {
        return ProgramDonasi::with(['kategori', 'penggalang'])
            ->where('featured', 0)
            ->where('status', 'active')
            ->orderBy('id', 'desc')
            ->get();
    });
    $berita = Cache::remember('berita_latest_4', 600, function () {
        return Berita::orderBy('tanggal', 'desc')->take(4)->get();
    });
    return view('pages.home', compact('featuredPrograms', 'otherPrograms', 'kategori', 'sliders', 'berita'));
}
b) Clear Cache Saat Update Data:

Di 
ProgramDonasiController.php
:

use Illuminate\Support\Facades\Cache;
public function store(StoreProgramDonasiRequest $request)
{
    // ... existing code ...
    
    ProgramDonasi::create($validated);
    
    // Clear cache
    Cache::forget('featured_programs');
    Cache::forget('other_programs');
    return redirect()->route('admin.programs.index')->with('success', 'Program Donasi Berhasil');
}
public function update(UpdateProgramDonasiRequest $request, ProgramDonasi $program)
{
    // ... existing code ...
    
    $program->update($validated);
    
    // Clear cache
    Cache::forget('featured_programs');
    Cache::forget('other_programs');
    return redirect()->route('admin.programs.index')->with('success', 'Program Donasi Berhasil Diubah');
}
c) Cache Stats di Dashboard:

Di 
AdminController.php
:

public function dashboard()
{
    // Cache stats selama 5 menit
    $stats = Cache::remember('dashboard_stats', 300, function () {
        return [
            "total_programs" => ProgramDonasi::count(),
            "total_donations" => Donation::count(),
            "total_amount" => ProgramDonasi::sum("collected_amount"),
            "total_users" => 0,
        ];
    });
    // Recent donations tidak perlu cache karena harus realtime
    $recent_donations_query = Donation::latest()
        ->with("program")
        ->take(3)
        ->get();
    // ... rest of code
}
âš ï¸ Important: Pastikan cache table sudah ada:

php artisan cache:table
php artisan migrate
4. Inefficient Queries ğŸŸ 
a) Select All Columns
Masalah: Banyak query yang select semua kolom padahal tidak semua digunakan.

Contoh di 
AdminController.php:L62
:

// âŒ Bad
$programs = ProgramDonasi::orderBy("title", "asc")->get(["id", "title"]);
Sebenarnya ini sudah bagus! Tapi di tempat lain masih banyak yang ->get() tanpa specify columns.

ğŸ’¡ Solusi:
HomeController.php
:

public function programs()
{
    $kategories = KategoriDonasi::select('id', 'name', 'slug')->get();
    // Specify columns yang dibutuhkan
    $programs = ProgramDonasi::select(
            'id', 'slug', 'title', 'short_description', 'gambar',
            'target_amount', 'collected_amount', 'end_date',
            'status', 'verified', 'kategori_id'
        )
        ->with(['kategori:id,name,slug'])  // Juga specify untuk eager load
        ->where('status', 'active')
        ->latest()
        ->get();
    return view('pages.program-donasi.programs', compact('kategories', 'programs'));
}
b) Count Query Bisa Dioptimasi
Di 
HomeController.php:L53
:

// âŒ Bad - Ini akan load semua data donation dulu baru count
$donorsCount = $program->donations()->where('status', 'success')->count();
// âœ… Good - Direct count query
$donorsCount = $program->donations()->where('status', 'success')->count();
Sebenarnya ini sudah OK, tapi bisa lebih baik dengan cache:

$donorsCount = Cache::remember("donors_count_{$program->id}", 300, function () use ($program) {
    return $program->donations()->where('status', 'success')->count();
});
5. Missing Status Filter ğŸŸ 
Di 
HomeController.php:L18
:

// âŒ Bad - Menampilkan semua program termasuk yang non-aktif
$otherPrograms = ProgramDonasi::where('featured', 0)->orderBy('id', 'desc')->get();
// âœ… Good
$otherPrograms = ProgramDonasi::with(['kategori', 'penggalang'])
    ->where('featured', 0)
    ->where('status', 'active')  // Tambahkan ini
    ->orderBy('id', 'desc')
    ->get();
ğŸŸ¡ MEDIUM PRIORITY ISSUES
6. Duplicate Code ğŸŸ¡
Di 
Donation.php
: Ada 5 method untuk set status yang mirip-mirip.

ğŸ’¡ Solusi - Refactor:
class Donation extends Model
{
    // ... existing code ...
    /**
     * Set donation status and update timestamp
     */
    public function setStatus(string $status): void
    {
        $this->attributes['status'] = $status;
        $this->attributes['status_change_at'] = now();
        $this->save();
    }
    // Specific status setters tetap ada untuk backward compatibility
    public function setStatusUnpaid()
    {
        $this->setStatus('unpaid');
    }
    public function setStatusPending()
    {
        $this->setStatus('pending');
    }
    public function setStatusSuccess()
    {
        $this->setStatus('success');
    }
    public function setStatusFailed()
    {
        $this->setStatus('failed');
    }
    public function setStatusExpired()
    {
        $this->setStatus('expired');
    }
    // ... rest of code
}
7. Configuration Issues ğŸŸ¡
a) Redis Not Used
File: 
.env.example

Saat ini menggunakan CACHE_STORE=database, padahal Redis jauh lebih cepat.

ğŸ’¡ Solusi:
Jika di production, gunakan Redis:

# .env
CACHE_STORE=redis
QUEUE_CONNECTION=redis
SESSION_DRIVER=redis
REDIS_CLIENT=phpredis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
Install Redis di Windows:

# Via WSL atau Docker
docker run --name redis -p 6379:6379 -d redis
# Install PHP Redis extension
# Download dari: https://windows.php.net/downloads/pecl/releases/redis/
# Atau via composer:
composer require predis/predis
Update 
config/cache.php
: Sudah OK, tidak perlu diubah.

b) Database Strict Mode
config/database.php:L56

'strict' => true,  // âœ… Good - sudah true
Ini sudah benar. Strict mode mencegah data invalid masuk ke database.

8. Pagination Issues ğŸŸ¡
Di 
AdminController.php:L92
:

->paginate($perPage)
Default Laravel pagination load semua data untuk count. Untuk table besar, ini lambat.

ğŸ’¡ Solusi:
Gunakan simplePaginate() jika tidak butuh total count:

public function donasi(Request $request)
{
    // ... existing filters ...
    $donations = Donation::with("program")
        ->orderBy("created_at", "desc")
        // ... filters ...
        ->simplePaginate($perPage)  // Lebih cepat untuk large dataset
        ->withQueryString();
    return view("pages.admin.donasi.index", compact("donations", "programs"));
}
Atau tetap gunakan paginate() tapi dengan cursor pagination untuk performa lebih baik:

$donations = Donation::with("program")
    ->orderBy("created_at", "desc")
    // ... filters ...
    ->cursorPaginate($perPage)
    ->withQueryString();
9. Search Query Optimization ğŸŸ¡
Di 
HomeController.php:L67-72
:

$programs = ProgramDonasi::when($keyword, function ($query) use ($keyword) {
    $query
        ->where('title', 'like', "%{$keyword}%")
        ->orWhere('short_description', 'like', "%{$keyword}%")
        ->orWhere('deskripsi', 'like', "%{$keyword}%");  // LONGTEXT - very slow!
})
Masalah:

LIKE %keyword% tidak bisa menggunakan index
Search di deskripsi yang LONGTEXT sangat lambat
ğŸ’¡ Solusi:
Option 1: Fulltext Index

// Migration
Schema::table('program_donasi', function (Blueprint $table) {
    $table->fullText(['title', 'short_description'], 'ft_program_search');
});
// Controller
$programs = ProgramDonasi::when($keyword, function ($query) use ($keyword) {
    $query->whereFullText(['title', 'short_description'], $keyword);
})
->latest()
->paginate(10);
Option 2: Laravel Scout (Recommended for better search)

Install:

composer require laravel/scout
php artisan vendor:publish --provider="Laravel\Scout\ScoutServiceProvider"
Model:

use Laravel\Scout\Searchable;
class ProgramDonasi extends Model
{
    use Searchable;
    public function toSearchableArray()
    {
        return [
            'title' => $this->title,
            'short_description' => $this->short_description,
        ];
    }
}
Controller:

public function search(Request $request)
{
    $keyword = $request->input('q');
    $programs = ProgramDonasi::search($keyword)
        ->paginate(10);
    return view('pages.program-donasi.search', compact('programs', 'keyword'));
}
ğŸŸ¢ LOW PRIORITY / CODE QUALITY
10. Inconsistent Code Style ğŸŸ¢
Contoh:

Donation.php:L38
 menggunakan $this->status (property)
Donation.php:L31
 menggunakan $this->attributes['status'] (array)
Rekomendasi: Konsisten gunakan property accessor $this->status karena lebih clean.

11. Guarded vs Fillable ğŸŸ¢
Donation.php:L13
:

protected $guarded = [];  // âš ï¸ Allow mass assignment semua column
Lebih aman:

protected $fillable = [
    'donation_code',
    'program_donasi_id',
    'donor_name',
    'donor_phone',
    'donor_email',
    'donation_type',
    'amount',
    'note',
    'snap_token',
    'status',
    'status_change_at',
    'reminder_sent_at',
];
12. Unused Dates Property ğŸŸ¢
Donation.php:L11
:

protected $dates = ['deleted_at'];  // âš ï¸ Deprecated di Laravel 11
Perbaikan:

// Hapus $dates, gunakan $casts saja
protected $casts = [
    'amount' => 'integer',
    'status_change_at' => 'datetime',
    'created_at' => 'datetime',
    'updated_at' => 'datetime',
    'reminder_sent_at' => 'datetime',
    'deleted_at' => 'datetime',  // Add this
];
ğŸ“Š Performance Metrics Estimation
Before Optimization:
Homepage Load: ~500-800ms (10 queries tanpa cache)
Program Detail: ~300-500ms (5-8 queries)
Admin Donations List: ~1-2s untuk 1000+ records tanpa index
After Optimization:
Homepage Load: ~150-250ms (cache hit, eager loading)
Program Detail: ~100-200ms (cache + eager loading)
Admin Donations List: ~200-400ms (dengan index dan pagination)
Estimated Speed Improvement: 60-70% faster

ğŸ¯ Implementation Priority
Phase 1 (Week 1) - Critical:
âœ… Add database indexes (30 min)
âœ… Fix N+1 queries di HomeController & DonasiController (1 hour)
âœ… Add basic caching untuk homepage (1 hour)
Phase 2 (Week 2) - High:
âœ… Implement caching di semua controller (2-3 hours)
âœ… Optimize queries dengan select specific columns (1 hour)
âœ… Add status filter di otherPrograms (10 min)
Phase 3 (Week 3) - Medium:
âœ… Refactor duplicate code (30 min)
âœ… Configure Redis (jika production) (1 hour)
âœ… Optimize search dengan fulltext index (1 hour)
Phase 4 (Optional) - Low:
âœ… Fix code style inconsistencies (30 min)
âœ… Replace $guarded dengan $fillable (15 min)
âœ… Update deprecated code (15 min)
ğŸ› ï¸ Quick Wins (Bisa Langsung Dikerjakan)
Ini yang paling mudah dan paling impact:

Add Indexes (Copy paste migration di atas) - +40% speed
Fix N+1 di HomeController (Tambah ->with()) - +30% speed
Cache Homepage (Wrap dengan Cache::remember()) - +50% speed on repeat visit
Total time: ~2 hours untuk 70% improvement! ğŸš€

ğŸ“ Conclusion
ğŸ‘ Yang Sudah Bagus:

âœ… Menggunakan Eloquent relationships dengan benar
âœ… Sudah pakai transactions untuk critical operations
âœ… Code structure clean dan mudah dibaca
âœ… Sudah pakai soft deletes
âš ï¸ Yang Perlu Diperbaiki:

âŒ Missing database indexes (critical)
âŒ N+1 query problems
âŒ Tidak ada caching sama sekali
âŒ Beberapa inefficient queries
Overall Grade: 7/10 - Good foundation, needs performance optimization.

ğŸ“ Next Steps
Review plan ini dengan team
Prioritize based on current traffic/pain points
Implement Phase 1 (critical fixes)
Monitor performance improvements
Iterate dengan Phase 2 dan seterusnya
Jangan ragu untuk tanya jika ada yang tidak jelas! ğŸ™Œ